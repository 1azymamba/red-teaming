# The Fundamental of AD

## ADの概要
- Active Directoryは、管理者がOS, アプリケーションユーザ、データアクセスを大規模に更新・管理できるようにするサービス。
- ADは標準構成でインストールされているが、管理者がニーズに合わせて設定をカスタマイズしていることが多い。
- ペンテスターの観点からすれば、ADには豊富な情報が含まれているため興味深いものとなる。
- ドメイン内の特定のオブジェクトの侵害に成功すると、組織のインフラを完全にコントロールできる可能性がある。

## ADの基礎用語と仕組み
- **オブジェクト**と呼ばれるユーザ、グループ、およびコンピュータに関する情報が保存されている。
- 各オブジェクトに設定された権限で、オブジェクトがドメイン内で持つ権限が決まる。
- ADのインスタンスを構成するための最初のステップは、corp.comのようなドメイン名を作成すること。
- AD環境はDNSサービスに依存関係があるため、一般的なDCは特定のドメインに対して権限を持つDNSサーバをホストしている。
- **OU**(組織単位)は、ドメイン内にオブジェクトを保存するために使用されるファイルシステムフォルダのようなもの。
- **コンピュータオブジェクト**=>ドメインに参加している実際のサーバとワークステーションを表す。
- **ユーザオブジェクト**=>ドメインに参加しているコンピュータへのログインに使用できるアカウントを表す。
- **属性**=>オブジェクトのタイプによって異なる。たとえば、ユーザオブジェクトには**名、性、ユーザ名、電話番号**などが属性として入ったりする。
- ユーザがドメインにログインしようとすると、**DC**にリクエストが送信される。そしてこのタイミングで、ユーザがドメインにログインできるかどうかがチェックされる。
- DCにはすべてのOU、オブジェクト、およびそれらの属性が含まれるため、ADの調査における最も重要なコンポーネントと言える。
- ADにはグループが存在し、オブジェクトをADグループに割り当ててまとめて管理することもできる。
- **Domain Admins**グループのメンバーは、ドメインの中で最も権限の高いオブジェクトの一つ。
- 攻撃者がこのグループのメンバー(ドメイン管理者)を侵害すると、基本的にドメインを完全に制御できることになる。
- ADへの攻撃においてピボットは重要で、仮に新たにログインできる別のユーザを見つけた場合、そのユーザを無視せずに改めてそのユーザ視点での列挙を行うことが重要。これらの積み重ねが攻撃を前進させる。

## Manual Enumeration
- ADとの通信では**LDAP**というプロトコルが使われる。
- LDAPパスの書き方は以下の形式。  
LDAP://HostName[:PortNumber][/DistinguishedName]
  
- ドメインの中には複数のDCが存在する可能性がある。
- 正確な列挙を行うには、最新の情報を保持している、**プライマリーDC**を見つけることが重要。
- PDCはドメインの中に1つしか存在しない。
- PDCを見つけるには、**PdcRoleOwner**というプロパティを保持するDCを見つける必要がある。これは、PowerShellと.NETを組み合わせてスクリプトを書いて見つける。
- LDAPの完全なパスにはHostName, PortNumber, DistinguishedNameの3つのパラメータが必須。ホスト名にはコンピュータ名、IPアドレス、またはドメイン名を使用できる。
- **DistinguishedName**(DN)はLDAPパスの一部で、ドメイン自体を含むAD内のオブジェクトを一意に識別する名前のこと。  
DNの例: CN=Stephanie,CN=Users,DC=corp,DC=com  
- 上記は、Stephanieがcorp.comドメイン内のユーザオブジェクトであることを表すDistinguishedNameになる。
- CNはCommon Nameで、DCはドメインコンポーネント。
- Microsoft.NETクラスのSystem.DirectoryServices.ActiveDirectoryという名前空間があり、ここにAD探索に使用できるクラスがいくつかある。今回はDomain Classに着目。
- PowerView.ps1等のツールを使ったりPowerShellから.NETクラスを呼び出してドメイン内の情報をクエリすることができる。
- ここでいう「クエリ」というのは、ドメイン内のLDAPに問い合わせをしているということになる。
- ペネトレーションにおいては、最初の侵害をした後にすぐ権限を昇格させるよりも、安定したfootholdを維持することが重要になる場合もある。
- 例えば、最初に侵害したユーザと同じレベルの権限を持つ他のユーザへのピボットができるようになっていれば、侵害したユーザがパスワードを変えた後でもネットワーク内に入り続けることができるからである。

## ドメイン内の探索
- **サービスアカウント**=>サービスを起動・囚虜するために使用されるアカウントのこと。高い特権を持つグループのメンバーであることも少なくない。
- IISやMS SQLといったサービスなどのアプリケーションがADに統合されると、**サービスプリンシパルネーム**(SPN)と呼ばれる一位のサービスインスタンスIDによって、サービスがAD内のサービスアカウントに紐づけられる。
- ドメイン内でサービスアカウントを列挙するには、**SPN**を列挙すればいい。

## ADの権限
- ADは各オブジェクトに対して権限を設けており、これをACE(Access Control Entry)で定義する。さらにこのACEはACL(Access Control List)を構成する。
- ACEによってオブジェクトに許可された権限に基づきターゲットオブジェクトにアクセスする。
- 攻撃の観点で興味深いADの権限は以下。  
```
GenericAll: Full permissions on object
GenericWrite: Edit certain attributes on the object
WriteOwner: Change ownership of the object
WriteDACL: Edit ACE's applied to object
AllExtendedRights: Change password, reset password, etc.
ForceChangePassword: Password change for object
Self (Self-Membership): Add ourselves to for example a group
```
- ADの権限設定は複雑なため、ACLの構成ミスは起こり得る。特に**Generic All**は最も強力な権限だが、自分が利用できるユーザがGeneric Allの権限を持っていないかをSIDをもとに確認することは重要。


## ドメイン共有
- ドメイン共有には環境に関する重要な情報が含まれていることが多い。
- PowerViewでドメイン共有を検索できるが、この時、**SYSVOL**は興味深い情報になる可能性がある。この共有フォルダはドメイン内の全てのユーザがアクセスでき、ドメインポリシーとスクリプトを格納している。


## Automated Enumeration
- 手動列挙を理解するのは重要だが、時間がかかる。なので特に大規模な環境では、自動ツールを使うことも検討するべき。
- 実業務では手動列挙と自動列挙の両方を使う。
- ただし多くの場合、商用利用で自動列挙ツールを使うとライセンス料がかかる。
- また、自動ツールは大量のネットワークトラフィックが発生するため、SOC等がいた場合にバレやすくなる点に注意。
- 手動と自動の両方を使うことが重要だが、自動でグラフィカルな図を作成し、よりアタックベクトルに気付きやすくなるといった利点がある。
- 

### SharpHoundによるデータ収集
- 
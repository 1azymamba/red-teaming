# AD環境における認証バイパスの攻撃手法

## NTLM認証
- パスワード攻撃のセクションでNTLMハッシュについては開設済みだが、ここではAD環境においてNTLMがどのように使われるかを解説。
- NTLMは、クライアントがホスト名ではなく**IP**アドレスによってサーバに対して認証する場合、またはユーザがAD統合DNSサーバに登録されていないホスト名に対して認証を試行する場合に使用される。
- 同様に、サードパーティのアプリケーションはKerberosの代わりにNTLM認証を選択・使用する場合がある。
- ADにおけるNTLM認証の手順↓
![alt text](image.png)  
  
解説  
1. まずクライアントがユーザのパスワードからNTLMハッシュを計算する
2. クライアントがユーザ名をサーバに送信
3. サーバがnonceまたはChallengeと呼ばれるランダムな値をクライアントに返す
4. クライアントがNTLMハッシュ(レスポンス)を使用してnonceを暗号化して、それをサーバに送信
5. サーバがユーザ名とnonceとともに、クライアントから受け取ったレスポンスをDCに転送
6. DCは全ユーザのNTLMハッシュを既に知っているので、DCが値の整合性をチェック
7. DCが、指定されたユーザ名のNTLMハッシュを使用してnonceを暗号化し、それをサーバから受信したレスポンスと比較する。値が等しければ認証に成功。
  
  
- NTLMはもちろん非可逆だが、最高級のGPUを搭載してHashcatなどをすると、毎秒6,000億を超えるハッシュのテストが可能。
- とはいえNTLM認証は多くのサードパーティアプリケーションで使用されているため、NTLMを完全に無効にしたAD環境の構築は難しく、ほとんどの環境ではNTLM認証は有効になっているのでペンテスターにとって非常に重要。



## Kerberos認証
- Kerberosは、Windows Server 2003行こうで、MSの主要な認証メカニズムとして使用されている。
- NTLM認証はチャレンジ&レスポンスで機能するが、Kerberosにおける認証は**チケットを使用する**点で大きく異なる。
- NTLMはクライアントとDCが直接やり取りせずDCとのやり取りは3rdパーティアプリケーションが行う
- Kerberosでは、**DCがKey Distribution Center**として使用される。
- KDCことKey Distribution Centerは各DC上で実行され、ユーザとコンピュータに対する**セッションチケット**と**temporary session key**を担当する。
  
  
Kerberos認証のフローは以下の通り。  
![alt text](image2.png)  
  
解説：  
1. ユーザがワークステーションにログインすると、**Authentication Server Request**(AS-REQ)がDCに送信される。
2. DCはKDCことKey Distribution Serverとしても機能する。AS-REQには、ユーザのパスワードとユーザ名から派生したハッシュを使用して暗号化されたタイムスタンプが含まれている。
3. DCがクライアントからのAS-REQを受信すると、**ntds.dit**ファイル内の特定のユーザに関連付けられたパスワードハッシュを検索して、ここでタイムスタンプの復号を試行する。
4. 復号が完了してタイムスタンプが重複していなければ、認証は成功したとみなされる。(タイムスタンプが重複していた場合は、潜在的に**リプレイ攻撃**が行われた可能性を示唆する)
5. 次に、DCは**Authentication Server Response**(AS-REP)をクライアントに返す。Kerberosはステートレスなプロトコルなので、AS-REPにはセッションキーと**Ticket Granting Ticket**(TGT)が含まれる。セッションキーはユーザのパスワードハッシュを使って暗号化され、クライアントによって復号されて再利用される可能性はある。
6. TGTには、**ユーザ、ドメイン、タイムスタンプ、クライアントのIPアドレス、セッションキー**に関する情報が含まれる。
7. 改ざんを防止するため、TGTはKDCのみが知っている秘密鍵(krbtgtアカウントのNTLMハッシュ)によって暗号化されていて、クライアントは復号できない。
8. クライアントがTGTとセッションキーを受信したが、KDCはクライアントの認証が完了したと判断する。
9. デフォルトではTGTは10時間有効で、その後更新される。


## MimikatzによるキャッシュされたADの認証情報ダンプ手法

- 最新バージョンのWindowsでは、横展開に使われるようなユーザのハッシュは**Local Security Authority Subsystem Service**こと(LSASS)メモリに保存される。
- この**LSASS**にキャッシュされたハッシュにアクセスできると、それを解読してパスワードを抽出できる可能性がある。
- ただしLSASSはOSの一部でありSYSTEM権限で実行されているため、**SYTEM権限**もしくは**ローカル管理者権限**が無いとハッシュへのアクセスができない。
- このLSASS内のハッシュをダンプするツールでの有名どころはやはり**Mimikatz**。
 [!NOTE] Mimikatzはそのままスタンドアロンアプリケーションとして使用すると、Windows Deffender等に引っかかるので、PowerShellなどからメモリにロードして使った方が良い。
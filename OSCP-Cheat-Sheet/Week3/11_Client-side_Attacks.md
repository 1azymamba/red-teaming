# Client-side Attacksの定義
[verisonのレポート](https://www.verizon.com/business/resources/reports/2022/dbir/2022-data-breach-investigations-report-dbir.pdf)によると、近年では脆弱性を突いて企業内部のNWに侵入するということはより難しくなってきている。  
実際に最も多いのは**資格情報への攻撃**であり、次に**フィッシング**が最初のNW侵入のための足掛かりとされることが多い。  
  
ここで、フィッシングは多くの場合、クライアント側の攻撃を利用する。このタイプの攻撃は、マルウェアをユーザに配信することで機能する。  
  
ターゲットユーザがマシン上でこれらのファイルを実行すると、内部NWへの足掛かりを得ることができる。  
  
これがClient-side Attacksの定義である。  
  
# Client-side Attacksの種類

Client-side Attacksでは、**ブラウザ、OSコンポーネント、オフィスプログラム**といったローカルソフトウェアやアプリケーションの脆弱性や機能を悪用することが多い。  
  
このClient-side Attacksで使われるマルウェアをユーザに配信するメカニズムでは、メールにファイルを添付するだけでなく、**USB Dropping**や**水飲み場攻撃**といった高度なメカニズムを使用することもある。  
  
近年はスパムフィルター、FWといった製品がファイルをスキャンしているため、電子メール経由でペイロードを配信することはますます難しくなってきている。
  
またClient-side Attacksは、基本的にはWebアプリケーションのような外部に公開されているマシンではなく、内部NWの外部からアクセスできない端末に攻撃を仕掛ける必要がある。

# Infomation Gathering
ターゲットの使っているアプリケーションやOSバージョン等の詳細情報を特定することは、これまでのClient-side Attacks以外の攻撃同様非常に重要。  
  
しかしこれまでのように外部から通信は直接できないため、nmapを使うことはできない。  
 
そのような状況下でターゲットクライアントの情報を収集するには、以下のような手法がある。  
1. 公的に入手可能なドキュメントのメタデータタグを調査する  
=>作成者、作成日、ドキュメントの作成に使用したソフトウェアの名前とバージョン、クライアントのOSといった、ドキュメントに関する多くの情報を入手できる可能性がある。  
また、ここでいう公的に入手可能な文書は、**Google Dorks**といった手法で検索して入手することができる。  
さらに、このメタデータの閲覧には[exiftool](OSCP-Cheat-Sheet\Tools\exiftool.md)というものを使用して閲覧することができる。  

> [!Tips]  
> exiftoolでメタタグを確認した時、極力最近の情報を信頼すること。古い情報だとOSなどのバージョンが現在のターゲットの状況と異なる可能性がある。  

## Client Fingerprinting
ここでは、内部NWに存在するターゲットのOSとブラウザの情報を取得する、というシナリオ(デバイスフィンガープリンティングと呼ぶ)というシナリオを考える。  
  
まず攻撃ベクトルの一つとして、ターゲットのメールアドレス宛てにHTAを送付して実行させ、Internet ExplorerもしくあｈMicrosoft Edgeのコンテキストでコードを実行させられる可能性がある。  
  
上記は多くのアクターによって利用される手口だが、これを実行するには、事前にターゲットシステムでWindowsを使っていること、また、Internet ExplorerやEdgeを使用していることが分かっていないといけない。  
  
そのための情報を得るのが、この**Client Fingerprinting**というステップになる。  
  
Client Fingerprintingの取得には、[CanaryTokens](https://canarytokens.org/generate)と呼ばれるWebからリンクを作成して、これをターゲットに訪問させる、という手法がある。  
  
より実用的なCanarytokensの使用方法としては、WordやPDF等のドキュメントにトークンを埋め込むことができるので、それを利用してターゲットにバレずにFingerprintingを行うといった方法がある。


# Microsoft Officeの悪用
攻撃アクターによるOfficeドキュメントを使った不正なマクロをつかった初期侵入は一般的な攻撃ベクトル。  
  
ただしこの攻撃ベクトルはベンダーも認識しているので、デフォルトではすべてのMicrosoft Officeドキュメントはフィルターで除外されていることが多い。(多くの企業向けのセキュリティ研修では、Officeドキュメントでマクロを有効化にする危険性を伝えている)  
  
そのため基本的には、悪意のあるドキュメントを添付ファイルとして送信することはできないと考えた方が良い。  
  
この状態でターゲットにファイルを開かせるには、メール文を工夫してダウンロードリンクなどの別の方法でドキュメントを開かせる方法が効果的。  
  
しかしここでも、Webからマクロファイルをダウンロードさせた場合、Officeドキュメントには**Mark of the Web(MOTW)**というメタタグが付与される。  
  
これによって編集とマクロの実行が無効になるため、攻撃者がマクロをターゲットのマシン上で実行させるには、ドキュメントをぼかしたりロックを解除させるようにするなどのメール配信時の工夫が必要。  
  
**ただし、これだけ現在のOffice製品がマクロ有効化に対する危険を喚起している現代でも、依然としてOfficeマクロを使った初期侵入は有効であり一般的な攻撃ベクトルになっている。**  
  
> [!Tips]  
> デフォルトのマクロ無効化をするMOTWタグをバイパスするテクニックとして、拡張子に.ixo, .rar, .zipといった文字列を含むという[バイパスがある](https://www.itworldcanada.com/post/attackers-try-to-bypass-microsofts-default-blocking-of-macros-in-office-suite)

## Wordマクロの悪用
- wordやExcel等のオフィス製品は、ユーザがマクロを埋め込むことができる。
- 攻撃者はマクロを埋め込んで、ターゲットがドキュメントを開いたときにリバースシェルを起動するようにすることができる。(もちろんここでも、攻撃者はターゲットにマクロを有効化するよう説得する文章を考える必要がある。)
- マクロを有効化したwordは、拡張子を**doc**にする必要がある。
- マクロでリバースシェルを起動する場合、いかのコマンドが使える。
```
CreateObject("Wscript.Shell").Run "powershell"
```
- Windows Scrript Host Shellを起動し、ここからpowershellを呼び出す。
- そして、**PowerCat**と使ってB64されたシェルを作り、このすくリプ尾をPowerShellからダウンロード、実行させる。
  
> [!Note]  
> VBAは255の文字制限があるため、b64でエンコードしたPowerShellのコマンドをそのまま一つの変数に格納することはできない。  
> なので、50文字ずつとかに分けてfor文を使って+で連結させていくのが良い。


# WIndowsライブラリファイルの悪用
- ライブラリファイルには**Library-ms**の拡張したついている
- 基本的にターゲットは、メール経由でこの.Library-msファイルを受け取ることになる。
- このLibrari-msファイルはダブルクリックで実行ができる
- **WebDav**というディレクトリがダブルクリック後に出現するはずなので、このディレクトリ配下に.lnkのショートカットファイルを置いておく。これがリバースシェルになる。
- ここでミソなのが、Windowsライブラリファイルを使った攻撃はメール経由でファイルを送信する必要があるということ。
- ほとんどのスパムフィルターやセキュリティ製品は.lnkの内容を解析して検出できてしまう。
- なのでApache経由でダウンロードとかさせても検出される。
- 一方メールで渡すと、このLibrary-msはユーザにフィルタされずにそのまま渡される。
- ここでターゲット上に評jしあれるExplorerは、実際にはWebDav共有のリモート側の攻撃者のディレクトリ。

## Windows Library Fileを使った攻撃の流れ
1. KaliでWebDav共有を有効にする
```
pip3 install wsgidav
```
2. wsgidavを実行して外部からの通信を受け付けるようにする
```
/home/kali/.local/bin/wsgidav --host=0.0.0.0 --port=80 --auth=anonymous --root /home/kali/webdav/
```

3. Windows Library Fileを作成、編集する。Library-msはxml形式でファイルをいじれるので、そこからアイコンや接続先URLなどのメタ情報を構築していく。

4. 
# Password Attacks

- ユーザ名が分かっている場合は辞書攻撃を狙う
- ユーザ名が分からない場合はより丁寧な偵察を行ってユーザ名を見つけるか、**パスワードスプレー**によってさまざまなユーザ名に対して1つのパスワードを使ってみる
- **ScatteredSecrets**といった、漏洩したパスワード情報を公開しているDBを使うこともできるが、利用に際して法的な問題が無いかを必ず確認すること( e.g) WeLeakInfoは最近FBIにBANされたらしい) 
- 基本的にはブルートフォース保護の機構として、3回連続でパスワードを間違えた時などにアカウントがロックされたりする。なのでやみくもにツールを使わずまずは慎重に偵察を行うこと
> [!NOTE]  
> 演習やLabでは、パスワード関連の攻撃をする際は3分以上時間がかかるようなら別のアプローチを選択すること(特にOSCPでは)

## ハッシュのクラッキング手法
1. ハッシュを取得する
2. ハッシュアルゴリズムの特定(**hash-identifier**か[hashid](OSCP-Cheat-Sheet\Tools\hashid.md)で識別が可能)
3. クラッキングにかかる時間の計算(時間がかかりすぎる場合はクラウドを使うかハードウェアをアップグレードする)
4. 調査したパスワードポリシーに基づいてワードリストを選定
5. クラッキングの実行

> [!Tips]  
> ハッシュに$がついてることがある。これは通常、ハッシュ値とソルトの区切り文字である。  
> 例：  
> $1$Bpo9ttg6$sWupAOzq1LrawrmDUBwPE0  
> Bpo9ttg6がソルト、sWupAOzq1LrawrmDUBwPE0がハッシュ値

他にもハッシュのアルゴリズム、手法は多くある。例えば  
**bcrypt**  
=> $2y$[コスト]$[ソルト][ハッシュ値]  
=> 上記の形式で表される  
=> "$2y$10$XrrpX8RD6IFvBwtzPuTlcOqJ8kO2px2xsh17f60GZsBKLeszsQTBC"

### John the Ripper
[JtR](OSCP-Cheat-Sheet\Tools\JohntheRipper.md)とも呼ばれるこのツールは、Hashcatと並んで有名なハッシュのクラッキングツール。  
- GPUもサポートするCPUベースのクラッキングツール。
- メインはCPU
- 基本的にはGPUを使う方がクラッキングは早くなる
- 

### Hashcat
- [Hashcat](OSCP-Cheat-Sheet\Tools\Hashcat.md)はCPUもサポートするGPUベースのクラッキングツール。
- メインがGPUという点がJtRと違う。

### クラッキングの解析時間の計測
- クラッキングにかかる時間は、キー空間をハッシュレートで割ることによって計算できる
  
例：  
大文字のアルファベットが26文字  
小文字のアルファベットが26文字  
0から9までの数字が合計10文字  
合計で62文字  
この状態で5文字のパスワードをクラッキングする場合、62の5乗が全パターンになる。これが**キースペース**で、日本語なら**鍵空間**。  
  
上記の62 ** 5のパターンだと、916,132,832が**鍵空間**になる。  
  
次に**ハッシュレート**とは、1秒間にハッシュを計算できる数のこと。  
ハッシュレートを調べるには、Hashcatのベンチマークモードをhashcat -bで、特定のハードウェア上のハッシュレート計算ができる。  
  
ハッシュの長さはMD5やSHA1、SHA-256などのアルゴリズムによって異なるため、アルゴリズムごとに計算にかかる時間ももちろん異なる。結果もハードウェアごとに異なる。  
  
長いパスワードは指数関数的に時間が増えるが、複雑なパスワードは多項式時間的に増加する。


## ハッシュのフォーマット
ハッシュに対するクラッキングを行う際、事前にアルゴリズムの特定とハッシュをクラックできるフォーマットに変換する作業が必要になる。  
そのためには**keepass2john**や**ssh2john**といったツールを使用できる。これを使い、hashcatやjohn用のフォーマットに出力できる。

> [!TIPS0]  
> ハッシュのパスワードポリシーを自身で作るときは、!, @, #の特殊文字を優先的に使うといい。英語キーボードにおいてはこの3つがキーボードの左側に配置されているため使われる可能性が高い。(日本語キーボードの場合はやや異なる)

## NTLMについて
NT LAN ManagerことNTLMは、Windows上でのパスワードの保管で使われる。  
  
Windowsは、ハッシュ化されたユーザのパスワードをSAM(Security Account Manager)というDBファイルに保存する。  
  
ここで、WIndows NTはLAN Manager(LM)というハッシュ形式とNTLMの2つの形式を持っている。  
  
LMはDESに基づいているが、非常に弱い。大文字小文字が区別されず、14文字を超えられない。パスワードが7文字を超える場合は2つの文字列に分割されてそれぞれが個別にハッシュ化される。  

Windows Vista、Win server 2008以降LMはデフォルトで無効になっている。  

  
  
### NTLMの特徴
- LMより強いハッシュ形式として登場
- パスワードの大文字と小文字を区別
- LMのように7文字を超えるときにパスワードを分割しない
- SM データベースに保存されるNTLMハッシュはソルト化されていない

### Pass-the-Hash(PtH)について
- NTLMのハッシュを解析できない場合がある
- そのようなケースでも、PtHの手法を使うことで、NTLMハッシュをペネトレーションテストに生かすことができる場合がある
- PtHを使うと、NTLMハッシュを解読できなくても、ユーザ名とNTLMハッシュ値の組み合わせで権限へのログインができる
- 条件として、NTLM/LMハッシュがソルトされていない必要がある(ただしNTLMはSMデータベースに保存されているときにはソルトされていない)

### Net-NTLMv2の特徴
- ペンテストの際、特権のないユーザとしてWindowsシステム上でコード実行またはシェルの取得をしないといけないケースがある
- そのようなケースでは、Mimikatz等のツールを使用してパスワードやNTLMハッシュを取得することができない
- そのような場合に、NTLMv2ネットワーク認証プロトコルを使える
- Net-NTLMv2プロトコルは、ネットワーク上のWindowsクライアントとサーバの認証プロセスを管理する。Net-NTLMv2を使うことで、SMB share等にアクセスすることができるようになる
- 最新のKerberosプロトコルよりは安全性が低い
- ただしリアルな環境でも、最新のKerberosをサポートせず、古いNet-NTLMv2に依存している環境は少なくない
  
認証の流れは以下  
1. リクエストをサーバに送る
2. サーバからクライアントにIDを証明するためにNTLMハッシュを使用して応答のデータを暗号化するチャレンジを送る
3. サーバはチャレンジ応答をチェックして許可と拒否を選択

### Net-NTLMv2のクラッキング手法
1. Responderというツールを使って通信をキャプチャする
2. Kali側でダミーのSMB共有をサーバとして受け付ける
3. ターゲット上の適当なユーザ権限でダミーのSMBにリクエストを投げてみる
4. そうするとNet-NTLMv2ハッシュをResponderがキャプチャする
5. Hashcat等のツールで解読する

## 
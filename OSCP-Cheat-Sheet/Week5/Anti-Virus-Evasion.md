# Anti Virus Evasion

ウイルス対策製品の検出回避について。  
以下にも記載があるが、マルウェア対策製品の検出回避技術は大きく、**On-disk evasion**と**In-memory evasion**の2つに大別される。

## On-disk evasion
ディスク上に物理的に保存されているマルウェアに修正を加えることに重点をおいている。  
多くの場合、検出回避のためには難読化(obfuscation)が重要となる。  
以下が難読化に使われることが多い。  
- パッカー => 簡単に使える。そのまま.exeとして動かすことができ、実行ファイルのサイズも小さくなる。ハッシュが変わる。**UPX**などが有名だが、この程度だと検出回避は難しい。  
- Obfuscators => りばえを難しくする。無関係な命令やデッドコードを挿入するなど。実行時にはin-memoryで実行する機能もあり、AV回避に有効。
- Crypter software => 実行可能なコードを暗号的に変更。実行と気に元のコードを復元する。この複合動作はin-memoryで行われ、暗号化されたコードのみがディスクに残る。AV回避の技術として有効。  
  
AV回避技術を使う場合は、これらの技術を組み合わせることが重要。  
**現状、AV回避をするための活発にメンテナンスされているフリーツールはほとんどない。**  
**The Enigma Protector4**というツールが有料だがAV回避用のツールとして有効。

## AVの検出技術
1. シグネチャベース => 既知のハッシュが一致したものを検出  
2. ヒューリスティックベース => 様々なルールとアルゴリズムに基づいて、ファイルのアクションが悪意のあるものかを判断する。バイナリファイルの命令をステップ実行するか、マシンコードを逆アセンブルして実現されるらしい。  
3. Behavior-Based Detection => バイナリの動作を動的に分析、小規模なサンドボックスでファイルを実行してアクションを見る
4. 機械学習型検出 => 未知の脅威を検出するMLアルゴリズムを使う

## In-memory evasion
On-disk evasionよりも検出回避がしやすいので、近年はIn-memoryの技術を使用することが多い。  
  
AV製品は主にディスク操作をチェックするが、この手法はディスクにファイルを書き込まないという点で良い。  
  
1. リモートプロセスメモリインジェクション => 正規のPEにペイロードをインジェクションする手法。 OpenProcess関数などで正規プロセスのHANDLEを取得し、VirtualAllocExなどのWinAPIを呼び出してリモートプロセスにメモリを割り当てる。最後にWriteProcessMemoryで書き込みを行う。これはPowerShellでもできる。
2. **Process Hollowing**

## AV回避のテスト
自身でAVの検出を回避するようなソフトウェアをコンパイルした場合でも、一度VTやWindows Deffenderに送信してしまうと、その後は登録しているセキュリティベンダーのサンドボックスなどで検出されるようになってしまう。なので外部への送信機能は必ずOFFにしておく必要がある。  
  
- 実際のペンテストでバイパスを狙うときは、すべてのAV製品をバイパスできるようにするのではなく、ターゲット上で動作しているAV製品を特定し、それをバイパスするようにカスタムするのが効率的。
- まずはAV製品が意図したとおりに動くかをチェックするために、検出されるカスタムしていないPEファイルなどを検出させてからテストに移る
- リモートプロセスメモリインジェクションの手法を使う場合、PowerShellを使うと便利。これはPEファイルではないためAV製品がスクリプトの内容を悪意のあるものかを解釈するのが難しいため、検出しづらいというメリットがある
- また、PowerShellはインタラクティブに実行できるので、スクリプトを書き換えるたびにいちいちコンパイルをする必要がない
- AV evasionのコツの一つは、変数名やタグ、コメントに一般的な名前を用いること
- 
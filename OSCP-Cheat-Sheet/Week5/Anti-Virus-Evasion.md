# Anti Virus Evasion

ウイルス対策製品の検出回避について。  
以下にも記載があるが、マルウェア対策製品の検出回避技術は大きく、**On-disk evasion**と**In-memory evasion**の2つに大別される。

## On-disk evasion
ディスク上に物理的に保存されているマルウェアに修正を加えることに重点をおいている。  
多くの場合、検出回避のためには難読化(obfuscation)が重要となる。  
以下が難読化に使われることが多い。  
- パッカー => 簡単に使える。そのまま.exeとして動かすことができ、実行ファイルのサイズも小さくなる。ハッシュが変わる。**UPX**などが有名だが、この程度だと検出回避は難しい。  
- Obfuscators => りばえを難しくする。無関係な命令やデッドコードを挿入するなど。実行時にはin-memoryで実行する機能もあり、AV回避に有効。
- Crypter software => 実行可能なコードを暗号的に変更。実行と気に元のコードを復元する。この複合動作はin-memoryで行われ、暗号化されたコードのみがディスクに残る。AV回避の技術として有効。  
  
AV回避技術を使う場合は、これらの技術を組み合わせることが重要。  
**現状、AV回避をするための活発にメンテナンスされているフリーツールはほとんどない。**  
**The Enigma Protector4**というツールが有料だがAV回避用のツールとして有効。

## In-memory evasion
On-disk evasionよりも検出回避がしやすいので、近年はIn-memoryの技術を使用することが多い。  
  
AV製品は主にディスク操作をチェックするが、この手法はディスクにファイルを書き込まないという点で良い。  
  
1. リモートプロセスメモリインジェクション => 正規のPEにペイロードをインジェクションする手法。 OpenProcess関数などで正規プロセスのHANDLEを取得し、VirtualAllocExなどのWinAPIを呼び出してリモートプロセスにメモリを割り当てる。最後にWriteProcessMemoryで書き込みを行う。これはPowerShellでもできる。
2. **Process Hollowing**

# 検出技術

## シグネチャベース

## ヒューリスティック

## 振る舞い検出

## 機械学習検出
# このページでは、Web appへのAttackに関するTipsをまとめる

- WappalyzerでJavaScript libraries等が分かるが、ここで使われているjquery等のバージョン情報は、特定の脆弱性を受ける可能性があるバージョンであったりすることもあるので貴重な情報になり得る。

# X-Forwarded-For ヘッダによるIPアドレスのスプーフィング
**X-Forwarderd-For**というヘッダがあり、これはクライアントがサーバに接続するときにフォワードプロキシもしくはリバースプロキシを経由するときに、クライアントのIPアドレスをサーバに知らせるために利用される。
サーバはプロキシを経由したアクセスにおいて、プロキシのIPアドレスしか見ていない。

そこでこのX-Forwarded-Forヘッダを使うと、サーバはクライアントのIPアドレスを解釈できる。
ただし信頼できるリバース・フォワードプロキシが無いとセキュリティリスクにつながる。

```
X-Forwarded-For: <client>, <proxy1>, <proxy2>
```

## XSS
XSSは、StoredとReflectedの2種類に大別される。
この種の攻撃は、Webアプリケーション側ではなくクライアントのブラウザ上で実行される。
XSSは、セッションハイジャックや悪意のあるページへの強制的なリダイレクト、ターゲットユーザとしてのローカルアプリケーションの実行といった影響を及ぼす可能性がある。

### XSSの簡易特定手法
Wordlistを使ったFuzzingももちろん有効だが、簡易的にXSSの脆弱性が存在するかを確認する方法もある。

以下の文字列をユーザ入力としてインジェクションし、そのレスポンスなどを見る手法。
以下はHTMLやJSの文字コードなので、これらを適切にSanitizeしていない場合、WebアプリケーションはXSSに対して潜在的に脆弱な可能性がある。
```
< > ' " { } ;
```

### XSSへの対策
サニタイズとしてURLエンコーディングとHTMLエンコーディングが最も一般的に使用されている。
URLエンコーディングはパーセントエンコーディングとも呼ばれ、スペースを%20に変更するといった変換を行う。

### Stored XSS
- エクスプロイトペイロードがDBに保存されているとき、またはサーバにキャッシュされている場合に発生する
- WebアプリケーションはDBかサーバのキャッシュからこのペイロードを取得してユーザに表示するため、Stored XSSはすべてのユーザを攻撃する可能性がある。
- Stored XSSの脆弱性は、フォーラムやコメント欄、製品レビュー、またはユーザコンテンツを保存した後にレビューできるような場所などで見つかりやすい。

### Reflected XSS
- 通常Reflected XSSの攻撃では、細工されたリクエストまたはリンクにペイロードを含む。
- Webアプリケーションはこのペイロードを取得し、ページコンテンツ内に配置する。
- Reflected XSSはリクエストを送信した人、またはリンクにアクセスした人のみを攻撃する。
- Reflected XSSは、検索欄や検索結果、エラーメッセージにユーザの入力が含まれる場所などで発生する可能性が高い。

### DOM Based XSS
- DOM Based XSSは、ページのDOM内でのみ実行される。
- まず、ブラウザはページのHTMLコンテンツを解析し、内部でDOMを生成する。
- DOM Based XSSは、ページのDOMがユーザ制御の値で変更されたときに発生する。
- 重要なのは、DOM Based XSSは、ブラウザがページのHTMLコンテンツを解析し、その際にInjectionされたJavaScriptが実行されるときに発生するということ。

## JavaScript Refresher
- JSは、ブラウザ自体がJSを実行する機能であるJavaScriptエンジンを有している。
- JSの役割は、ページのDOMにアクセスして変更し、ユーザエクスペリエンスを向上させること
- 攻撃者の観点で言えば、JavaScriptコードをWebアプリケーションにインジェクションできれば、ターゲットユーザのブラウザ経由でJSペイロードが実行され、ターゲットユーザのブラウザ持つページのDOMにアクセスして変更もできるということになる。
- 攻撃者がDOMにアクセスできた場合、ログインフォームをリダイレクトしたりパスワードを奪ったり、セッションCookieを盗んだりといったことができるようになる。
- 以下のようなJSのコードは、ブラウザのConsole等から実行できる。

JSの例：
```.js
function multiplyValues(x,y) {
    return x * y;
}

let a = multiplyValues(3, 5)
console.log(a)
```

## XSSによる権限昇格
- XSSの脆弱性があれば、ユーザのブラウザ上でJSを実行できる。
- JSコードを実行して、ユーザのCookieとセッション情報を盗むことで、権限昇格につなげることができる
- このとき、CookieにHttpOnlyフラグが適用されていると、JSからCookieへのアクセスを拒否するようにできるが、このフラグが設定されていなければ、XSSペイロードによってCookieを盗める。
- もしくは、管理者アカウントを追加するJSを書いてそれをXSSペイロードにすることで、実際の管理者がコードを実行すれば、管理者アカウントが作成される。

> [!NOTES]
> WordPressには**nonce**値というものがあり、正当なページからの遷移であることを証明するためのワンタイムパスワードとして機能している。このnonce値が分かっていないと、ページからJSを実行しようとしても処理が受け入れられないので注意。このnonce値をURLのクエリストリングの中に<nonce=>として入れる必要がある。

以下のJSコードで、nonce値をページから正規表現を使って探すことができる。
```.js
var ajaxRequest = new XMLHttpRequest();
var requestURL = "/wp-admin/user-new.php";
var nonceRegex = /ser" value="([^"]*?)"/g;
ajaxRequest.open("GET", requestURL, false);
ajaxRequest.send();
var nonceMatch = nonceRegex.exec(ajaxRequest.responseText);
var nonce = nonceMatch[1];
```